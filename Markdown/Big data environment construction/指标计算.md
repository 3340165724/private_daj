# 指标计算

#####  1、根据dwd层表统计连续两个月下单并且下单金额保持增长的用户，存入MySQL数据库shtd_store的usercontinueorder表(表结构如下)中。然后在MySQL命令行中根据订单总数、消费总额、客户主键三列均逆序排序的方式，查询出前5条，将SQL语句与执行结果截图粘贴至对应报告中。

| 字段             | 类型   | 中文含义 | 备注                                                         |
| ---------------- | ------ | -------- | ------------------------------------------------------------ |
| custkey          | int    | 客户主键 |                                                              |
| custname         | text   | 客户名称 |                                                              |
| month            | text   | 月       | 记录当前月和下月，用下划线‘_’相连。 例如： 202201_202202 表示2022年1月到2月用户连续下单。 |
| totalconsumption | double | 消费总额 | 连续两月的订单总额                                           |
| totalorder       | int    | 订单总数 | 连续两月的订单总数                                           |



```
select  t1.CUSTKEY, t1.NAME, concat(concat(t1.y1, if(t1.m1<10,concat('0',t1.m1),t1.m1)),"_",concat(t2.y2,if(t2.m2<10,concat('0',t2.m2),t2.m2))) , t1.s1+t2.s2, t1.c1+t2.c2
from (
	select  c.CUSTKEY, c.NAME, YEAR(o.ORDERDATE) as y1, MONTH(o.ORDERDATE) as m1, SUM(o.TOTALPRICE) s1, COUNT(*) c1
	from customer as c 
	inner join  orders as o  on o.CUSTKEY = c.CUSTKEY
	group by  c.CUSTKEY, c.NAME, YEAR(o.ORDERDATE) , MONTH(o.ORDERDATE)) as t1
inner join (
	select  c.CUSTKEY, c.NAME, YEAR(o.ORDERDATE) as y2, MONTH(o.ORDERDATE) as m2, SUM(o.TOTALPRICE) s2, COUNT(*) c2
	from customer as c 
	inner join  orders as o  on o.CUSTKEY = c.CUSTKEY
	group by  c.CUSTKEY, c.NAME, YEAR(o.ORDERDATE) , MONTH(o.ORDERDATE)) as t2
on t1.CUSTKEY=t2.CUSTKEY 
where s1 < s2 and ((y1 = y2 and t1.m1 = t2.m2-1) or (y1 = y2-1 and t1.m1 =12 and t2.m2=01))
```

- 思路

  ````
  select * from 
  (查询各个客户各年、月下单的订单个数、总金额) as t1
  inner join 
  (查询各个客户各年、月下单的订单个数、总金额) as t2
  on t1.CUSTKEY=t2.CUSTKEY
  where 总金额小于下月的总金额 and 月份连续
  ````

- 具体分析

  - 统计每个用户连续下单的情况

    ```
    select  
    c.CUSTKEY, c.NAME, YEAR(o.ORDERDATE) , MONTH(o.ORDERDATE), SUM(o.TOTALPRICE), COUNT(*)
    from customer as c 
    inner join  orders as o  on o.CUSTKEY = c.CUSTKEY
    group by  c.CUSTKEY, c.NAME, YEAR(o.ORDERDATE) , MONTH(o.ORDERDATE)
    ```

  - 统计每个用户连续下单的情况

    ```
    select  t1.CUSTKEY, t1.NAME, concat(concat(t1.y1, if(t1.m1<10,concat('0',t1.m1),t1.m1)),"_",concat(t2.y2,if(t2.m2<10,concat('0',t2.m2),t2.m2))) , t1.s1+t2.s2, t1.c1+t2.c2
    from (
    	select  c.CUSTKEY, c.NAME, YEAR(o.ORDERDATE) as y1, MONTH(o.ORDERDATE) as m1, SUM(o.TOTALPRICE) s1, COUNT(*) c1
    	from customer as c 
    	inner join  orders as o  on o.CUSTKEY = c.CUSTKEY
    	group by  c.CUSTKEY, c.NAME, YEAR(o.ORDERDATE) , MONTH(o.ORDERDATE)) as t1
    inner join (
    	select  c.CUSTKEY, c.NAME, YEAR(o.ORDERDATE) as y2, MONTH(o.ORDERDATE) as m2, SUM(o.TOTALPRICE) s2, COUNT(*) c2
    	from customer as c 
    	inner join  orders as o  on o.CUSTKEY = c.CUSTKEY
    	group by  c.CUSTKEY, c.NAME, YEAR(o.ORDERDATE) , MONTH(o.ORDERDATE)) as t2
    on t1.CUSTKEY=t2.CUSTKEY and ((y1 = y2 and t1.m1 = t2.m2-1) or (y1 = y2-1 and t1.m1 =12 and t2.m2=01))
    ```

